#
# Build configuration for Circle CI
#

general:
    artifacts:
        - /home/ubuntu/your-app-name/app/build/outputs/apk/

machine:
    environment:
        ANDROID_HOME: /usr/local/android-sdk-linux

dependencies:
    override:
        - echo y | android update sdk --no-ui --all --filter tools,platform-tools,build-tools-19.1.0,android-19,extra-google-m2repository,extra-google-google_play_services,extra-android-support
        - ANDROID_HOME=/usr/local/android-sdk-linux ./gradlew dependencies

test:
    override:
        - (./gradlew assemble):
            timeout: 360version: 2
                        jobs:
                          build:
                            docker:
                              - image: menny/android_ndk:1.6.1a

                            working_directory: /opt/workspace/

                            environment:
                              CODECOV_TOKEN: 1a4cd171-2784-4f48-8a62-0b7ec31e6d7e
                              COV_REPORT_LOCATION: app/build/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml
                              TERM: dumb
                              _JAVA_OPTIONS: "-Xmx1400m -XX:ParallelGCThreads=2 -XX:ConcGCThreads=2 -XX:ParallelGCThreads=2 -Djava.util.concurrent.ForkJoinPool.common.parallelism=2"

                            steps:
                              - checkout

                              - restore_cache:
                                  key: anysoftkeyboard-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}-{{ checksum "circle.yml" }}-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}

                              - run:
                                  name: Setup environment
                                  command: scripts/ci_setup.sh
                        
                              - run:
                                  name: Run Tests
                                  command: |
                                    if [ "${CIRCLE_NODE_INDEX}" != "0" ]; then
                                      export TEST_GROUP_INDEX=$(( ${CIRCLE_NODE_INDEX} - 1 ))
                                      export TEST_GROUPS_COUNT=$(( ${CIRCLE_NODE_TOTAL} - 1 ))
                                      echo "Running test group ${TEST_GROUP_INDEX} out of ${TEST_GROUPS_COUNT}..."
                                      ./scripts/ci_test.sh
                                      if [[ -f $COV_REPORT_LOCATION ]]; then
                                        ./scripts/ci_binaries/codecov.sh -X gcov -X coveragepy -f ${COV_REPORT_LOCATION}
                                      fi
                                    fi

                              - store_artifacts:
                                  path: app/build/reports/tests/
                                  destination: tests_reports/

                              - store_test_results:
                                  path: "app/build/test-results/testDebugUnitTest/"

                              - deploy:
                                  name: Deploy to Play Store
                                  command: |
                                    if [ "${CIRCLE_BRANCH}" == "master" ] && [ "${CIRCLE_PROJECT_USERNAME}" == "AnySoftKeyboard" ]; then
                                      ./scripts/ci_deploy.sh $KEYSTORE_FILE_URL $PUBLISH_CERT_FILE_URL
                                    fi

                              - store_artifacts:
                                    path: app/build/outputs/apk/
                                    destination: apks/

                              - store_artifacts:
                                    path: app/build/outputs/mapping/
                                    destination: mapping/

                              - save_cache:
                                        key: anysoftkeyboard-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}-{{ checksum "circle.yml" }}-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
                                        paths:
                                          - "~/.gradle/3.4.1"
                                          - "~/.gradle/wrapper/dists/gradle-3.4.1-bin"
                                          - "~/.gradle/caches/modules-2"
                                          - "~/.gradle/buildOutputCleanup"
                                          - "~/.m2"